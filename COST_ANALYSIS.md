# Gemini 2.5 Flash コスト分析

## 📊 正確な料金体系

### Gemini 2.5 Flash (gemini-flash-latest)
- **Input:** $0.30 per 1M tokens ($0.0003 per 1K tokens)
- **Output:** $2.50 per 1M tokens ($0.0025 per 1K tokens)
- **Context Caching:** $0.03 per 1M tokens

## 💰 典型的なリクエストのコスト計算

### シナリオ例
- **ユーザーメッセージ:** 200文字
- **会話履歴:** 5メッセージ (約500文字)
- **合計Input:** 700文字 ≈ 1,050トークン
- **AI応答Output:** 500トークン

### コスト計算
```
Input Cost  = 1,050 tokens × $0.0003 / 1K = $0.000315
Output Cost = 500 tokens × $0.0025 / 1K  = $0.00125
────────────────────────────────────────────────────
Total per request = $0.001565 (約 $0.0016)
```

## 📈 スケール別コスト試算

| リクエスト数 | 総コスト | 月間コスト (30日) |
|-------------|----------|-------------------|
| 100 | $0.16 | $4.80 |
| 1,000 | $1.57 | $47.10 |
| 5,000 | $7.83 | $234.90 |
| 10,000 | $15.65 | $469.50 |
| 50,000 | $78.25 | $2,347.50 |

## 🎯 現在の予算制限との比較

### 設定されている制限 (`api/rate-limiter.ts`)
```typescript
global: {
  maxCostPerHour: 5.0,    // $5/時間
  maxCostPerDay: 50.0,    // $50/日
  emergencyStopCost: 75.0, // $75 緊急停止
}
```

### 制限内で処理できるリクエスト数

| 制限 | リクエスト数 |
|------|-------------|
| **時間制限 ($5)** | ~3,195 リクエスト/時 |
| **日次制限 ($50)** | ~31,949 リクエスト/日 |
| **緊急停止 ($75)** | ~47,923 リクエスト |

### ユーザー数換算 (1ユーザー = 30リクエスト/日)
- **日次制限内:** ~1,065 アクティブユーザー/日
- **時間制限内:** ~106 同時アクティブユーザー/時

## ⚖️ モデル別コスト比較

| モデル | Input | Output | 1リクエスト | 1,000リクエスト | 相対コスト |
|--------|-------|--------|-------------|-----------------|-----------|
| Gemini 2.5 Flash | $0.30/1M | $2.50/1M | $0.00157 | $1.57 | 1.0x |
| Gemini 2.0 Flash | $0.10/1M | $0.40/1M | $0.00028 | $0.28 | **0.18x** |
| Gemini 2.5 Flash-Lite | $0.10/1M | $0.40/1M | $0.00028 | $0.28 | **0.18x** |

**💡 2.0 Flash または 2.5 Flash-Lite に変更すると、コストが約82%削減されます。**

## 🚨 重要な注意事項

### 1. 無料枠の活用
Gemini APIには無料枠があります：
- Input/Output: 無料（制限あり）
- 適切に活用すれば初期コストは最小限

### 2. コスト最適化の推奨事項

#### 即効性のある対策
1. **会話履歴の制限** (現在: 10メッセージ)
   ```typescript
   const recentHistory = conversationHistory.slice(-5); // 10 → 5に削減
   ```
   効果: Input トークン ~50%削減

2. **出力トークン数の最適化** (現在: 4096)
   ```typescript
   maxOutputTokens: 2048, // 4096 → 2048に削減
   ```
   効果: 出力コスト最大50%削減

3. **Context Caching の活用**
   - システムプロンプトをキャッシュ
   - Input コストを90%削減可能

#### 中期的な対策
1. **モデルの段階的使い分け**
   ```typescript
   // 簡単な質問: 2.0 Flash
   // 複雑な質問: 2.5 Flash
   const model = isComplexQuery(message)
     ? "gemini-2.5-flash"
     : "gemini-2.0-flash";
   ```

2. **レート制限の調整**
   ```typescript
   global: {
     maxCostPerHour: 3.0,  // $5 → $3
     maxCostPerDay: 30.0,  // $50 → $30
   }
   ```

## 📊 予算シミュレーション

### 月間予算別の処理可能リクエスト数

| 月間予算 | 日次平均 | リクエスト/月 | ユーザー数 (30req/日) |
|---------|---------|---------------|----------------------|
| $10 | $0.33 | ~6,369 | ~7人 |
| $50 | $1.67 | ~31,847 | ~35人 |
| $100 | $3.33 | ~63,694 | ~71人 |
| $500 | $16.67 | ~318,471 | ~354人 |
| $1,000 | $33.33 | ~636,943 | ~707人 |

### 現在の設定 ($50/日 = $1,500/月)
- **月間リクエスト:** ~956,524
- **対応可能ユーザー:** ~1,063人/日

## 🎯 推奨アクション

### オプション1: 現状維持 + 最適化
- ✅ Gemini 2.5 Flash を継続使用
- ✅ 会話履歴を5メッセージに削減
- ✅ maxOutputTokens を 2048 に削減
- **効果:** コスト ~40%削減

### オプション2: モデル変更
- ✅ `gemini-2.0-flash-latest` に変更
- ✅ コスト82%削減
- ⚠️ 思考プロセス機能なし

### オプション3: ハイブリッド運用
- ✅ 通常: 2.0 Flash
- ✅ 複雑な質問: 2.5 Flash
- **効果:** コスト ~60-70%削減、品質維持

## 📝 次のステップ

1. ✅ コスト計算式を2.5 Flash用に更新（完了）
2. ⬜ 会話履歴制限の見直し
3. ⬜ maxOutputTokens の調整
4. ⬜ Context Caching の実装検討
5. ⬜ 実際の使用状況モニタリング（/api/stats）

---

**更新日:** 2025-10-11
**モデル:** gemini-flash-latest (Gemini 2.5 Flash)
